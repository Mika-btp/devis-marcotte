<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Devis avec TVA dynamique</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      max-width: 900px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    th, td {
      border: 1px solid #aaa;
      padding: 8px;
      text-align: center;
    }
    input[type="number"], input[type="text"], select {
      width: 90%;
      padding: 4px;
      box-sizing: border-box;
    }
    .right {
      text-align: right;
    }
    #totals {
      margin-top: 10px;
      text-align: right;
      font-weight: bold;
    }
    button {
      margin-right: 10px;
      padding: 8px 12px;
      cursor: pointer;
    }
    .tva-cell {
      font-size: 0.9em;
      color: #555;
      white-space: normal;
    }
  </style>
</head>
<body>

  <h1>Devis n° <span id="devisNumber">1</span></h1>

  <label>Nom client : <input type="text" id="clientName" /></label><br /><br />
  <label>Adresse client : <input type="text" id="clientAddress" style="width: 100%;" /></label><br /><br />
  <label>SIRET : <input type="text" id="clientSiret" /></label><br /><br />
  <label>Téléphone : <input type="text" id="phone" /></label><br /><br />

  <label>Date du devis : <input type="date" id="devisDate" /></label>
  <label style="margin-left: 30px;">Validité jusqu’au : <input type="date" id="validUntil" /></label>

  <br /><br />

  <table>
    <thead>
      <tr>
        <th style="width: 35%;">DÉSIGNATION</th>
        <th style="width: 10%;">QUANTITÉ</th>
        <th style="width: 15%;">PRIX UNITAIRE</th>
        <th style="width: 10%;">TVA %</th>
        <th style="width: 15%;">TOTAL HT</th>
        <th style="width: 15%;">TVA</th>
      </tr>
    </thead>
    <tbody id="itemsTable">
      <tr>
        <td><input type="text" placeholder="Description de la prestation" /></td>
        <td><input type="number" class="qty-input" value="1" min="0" step="1" /></td>
        <td><input type="number" class="price-input" value="0.00" min="0" step="0.01" /></td>
        <td>
          <select class="tva-select">
            <option value="0">0%</option>
            <option value="0.10">10%</option>
            <option value="0.20" selected>20%</option>
          </select>
        </td>
        <td class="total-cell">0.00 €</td>
        <td class="tva-cell">0.00 €</td>
      </tr>
    </tbody>
  </table>

  <button onclick="addItem()">Ajouter une ligne</button>
  <button onclick="newDevis()">Nouveau devis</button>

  <div id="totals">
    Total HT : <span id="totalHT">0.00 €</span><br />
    Total TVA : <span id="totalTVA">0.00 €</span><br />
    Total TTC : <span id="totalTTC">0.00 €</span>
  </div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    // Initialiser les dates et totaux
    document.getElementById('devisDate').value = new Date().toISOString().split('T')[0];
    const validDate = new Date();
    validDate.setDate(validDate.getDate() + 30);
    document.getElementById('validUntil').value = validDate.toISOString().split('T')[0];
    calculateTotals();

    // Ajout des événements sur la ligne initiale
    document.querySelectorAll('.qty-input').forEach(input => {
      input.addEventListener('input', e => calculateRowAndTotals(e.target));
    });
    document.querySelectorAll('.price-input').forEach(input => {
      input.addEventListener('input', e => calculateRowAndTotals(e.target));
    });
    document.querySelectorAll('.tva-select').forEach(select => {
      select.addEventListener('change', e => calculateRowAndTotals(e.target));
    });
  });

  let currentDevisNumber = parseInt(localStorage.getItem('devisNumber')) || 1;
  document.getElementById('devisNumber').textContent = currentDevisNumber;

  function calculateRowAndTotals(input) {
    const row = input.closest('tr');
    const qty = parseFloat(row.querySelector('.qty-input').value) || 0;
    const price = parseFloat(row.querySelector('.price-input').value) || 0;
    const tvaRate = parseFloat(row.querySelector('.tva-select').value) || 0;

    const total = qty * price;
    const tvaAmount = total * tvaRate;

    row.querySelector('.total-cell').textContent = total.toFixed(2) + ' €';

    if (tvaRate === 0) {
      row.querySelector('.tva-cell').innerHTML = 'TVA non applicable,<br>Article 293 du CGI';
    } else {
      row.querySelector('.tva-cell').textContent = tvaAmount.toFixed(2) + ' €';
    }

    calculateTotals();
  }

  function calculateTotals() {
    let totalHT = 0;
    let totalTVA = 0;

    document.querySelectorAll('#itemsTable tr').forEach(row => {
      const qty = parseFloat(row.querySelector('.qty-input').value) || 0;
      const price = parseFloat(row.querySelector('.price-input').value) || 0;
      const tvaRate = parseFloat(row.querySelector('.tva-select').value) || 0;

      const lineTotal = qty * price;
      const lineTVA = lineTotal * tvaRate;

      totalHT += lineTotal;
      totalTVA += lineTVA;

      // Met à jour la ligne (au cas où)
      row.querySelector('.total-cell').textContent = lineTotal.toFixed(2) + ' €';

      if (tvaRate === 0) {
        row.querySelector('.tva-cell').innerHTML = 'TVA non applicable,<br>Article 293 du CGI';
      } else {
        row.querySelector('.tva-cell').textContent = lineTVA.toFixed(2) + ' €';
      }
    });

    document.getElementById('totalHT').textContent = totalHT.toFixed(2) + ' €';
    document.getElementById('totalTVA').textContent = totalTVA.toFixed(2) + ' €';
    document.getElementById('totalTTC').textContent = (totalHT + totalTVA).toFixed(2) + ' €';
  }

  function addItem() {
    const tbody = document.getElementById('itemsTable');
    const newRow = document.createElement('tr');
    newRow.innerHTML = `
      <td><input type="text" placeholder="Description de la prestation" /></td>
      <td><input type="number" class="qty-input" value="1" min="0" step="1" /></td>
      <td><input type="number" class="price-input" value="0.00" min="0" step="0.01" /></td>
      <td>
        <select class="tva-select">
          <option value="0">0%</option>
          <option value="0.10">10%</option>
          <option value="0.20" selected>20%</option>
        </select>
      </td>
      <td class="total-cell">0.00 €</td>
      <td class="tva-cell">0.00 €</td>
    `;
    tbody.appendChild(newRow);

    // Ajouter les événements sur la nouvelle ligne
    newRow.querySelector('.qty-input').addEventListener('input', e => calculateRowAndTotals(e.target));
    newRow.querySelector('.price-input').addEventListener('input', e => calculateRowAndTotals(e.target));
    newRow.querySelector('.tva-select').addEventListener('change', e => calculateRowAndTotals(e.target));
  }

  function newDevis() {
    currentDevisNumber++;
    localStorage.setItem('devisNumber', currentDevisNumber);
    document.getElementById('devisNumber').textContent = currentDevisNumber;

    // Réinitialisation des champs client
    document.getElementById('clientName').value = '';
    document.getElementById('clientAddress').value = '';
    document.getElementById('clientSiret').value = '';
    document.getElementById('phone').value = '';

    // Réinitialisation des dates
    document.getElementById('devisDate').value = new Date().toISOString().split('T')[0];
    const validDate = new Date();
    validDate.setDate(validDate.getDate() + 30);
    document.getElementById('validUntil').value = validDate.toISOString().split('T')[0];

    // Réinitialisation tableau avec une ligne vide
    document.getElementById('itemsTable').innerHTML = `
      <tr>
        <td><input type="text" placeholder="Description de la prestation" /></td>
        <td><input type="number" class="qty-input" value="1" min="0" step="1" /></td>
        <td><input type="number" class="price-input" value="0.00" min="0" step="0.01" /></td>
        <td>
          <select class="tva-select">
            <option value="0">0%</option>
            <option value="0.10">10%</option>
            <option value="0.20" selected>20%</option>
          </select>
        </td>
        <td class="total-cell">0.00 €</td>
        <td class="tva-cell">0.00 €</td>
      </tr>
    `;

    // Ajout des événements sur la nouvelle ligne
    const firstRow = document.querySelector('#itemsTable tr');
    firstRow.querySelector('.qty-input').addEventListener('input', e => calculateRowAndTotals(e.target));
    firstRow.querySelector('.price-input').addEventListener('input', e => calculateRowAndTotals(e.target));
    firstRow.querySelector('.tva-select').addEventListener('change', e => calculateRowAndTotals(e.target));

    calculateTotals();
  }
</script>

</body>
</html>
